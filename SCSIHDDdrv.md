# X680x0 SCSI HDD 埋め込みドライバについて

X680x0 は X68000 SUPER 以降の機種で SCSI デバイスがサポートされていますが、
Human68k 本体 (HUMAN.SYS) には SCSI ドライバは含まれていません。

SCSI デバイスドライバは SCSI HDD 自身の中に入っていて、SCSI インターフェースに搭載されている
ROM が SCSI デバイスからの起動の他に、起動したデバイス内にある SCSI デバイスドライバの読み込みも
サポートしています。
このドライバは Human68k の起動時、CONFIG.SYS からのドライバ読み込みを始める前に、ROMルーチンを用いて読み込みが行われるようになっています。

ここで読み込まれる SCSI デバイスドライバは FORMAT.X が内部に持っていて、フォーマットの際に SCSI HDD に書き込まれます。

## SCSI HDD の構成

|オフセット(バイト単位) | 内容|
|---------------------|-----|
|0x00000000~|SCSI HDDシグネチャ|
|0x00000400~|ブートセレクタ(起動時にHELPを押すと表示されるメニュー)|
|0x00000800~|パーティションテーブル|
|**0x00000c00~**|**SCSI HDD埋め込みデバイスドライバ**|
|0x00004000~|空き|
|0x00008000~|パーティション#0 ブートセクタ|
|0x00008400~|パーティション#0 FAT|
|0xXXXXXXXX~|パーティション#0 ルートディレクトリエントリT|
|0xXXXXXXXX~|パーティション#0 データ領域|

オフセット 0x000c00～0x003fff の 13KB の領域にSCSIデバイスドライバが埋め込まれています。


## SCSI HDD 埋め込みデバイスドライバの注意点

SCSI HDD 埋め込みのデバイスドライバは、基本的な仕組みは通常のHuman68kのデバイスドライバと同じですが、以下のような点が異なります。

* 通常のデバイスドライバ (\*.SYS) は拡張子が異なるのみでファイルフォーマットは実行ファイル(\*.X) と同じで、先頭に 64 バイトの X形式ヘッダが付いていますが、埋め込みデバイスドライバにはこのヘッダがありません。
* 埋め込みデバイスドライバはリロケーション情報を持ちません。デバイスヘッダ内の「ストラテジルーチンのエントリポイント」と「割り込みルーチンのエントリポイント」の2箇所のみ、ROM内のローダでロード先に合わせたリロケーション処理を行いますが、それ以外の箇所についてはリロケーションを行わないのでリロケータブルに作る必要があります。
* デバイスドライバの初期化はシステム起動の早い段階に行われるため、使用できるDOSコールにも制約があります。例えば、DOSコールによる文字出力はコンソールドライバの初期化前のため使用できません。
* 通常のデバイスドライバでのデータの受け渡しの他に、初期化時に特殊な引数が存在します。
  * SCSI ROMのデバイスドライバ読み込み時に、デバイスヘッダのオフセット +22 (デバイス名 8 バイトの直後) の 1バイトにパーティションテーブルから得た起動パーティション番号が書き込まれます。
この値は、デバイスドライバの初期化終了時にリクエストヘッダのオフセット +22 (ドライブ番号が渡される箇所)に設定しておく必要があります。
  * デバイスドライバエントリポイントで初期化コマンドが呼ばれる際の D2 レジスタには、これから初期化を行う SCSI ID + 1 の値が入っています。デバイスドライバ内で SCSI デバイスの読み込みを行う際に使用します。
* Human68k には、リモートデバイスの初期化を行った後に通常のブロックデバイスの初期化を行おうとするとコマンドコードが再設定されていないためクラッシュするという不具合があります ([こちらを参照](https://stdkmd.net/bugsx68k/#human_remoteboot))。
この対策のため、リモートドライブの初期化処理内ではリクエストヘッダのコマンドコードを $00 でクリアしておく必要があります。
